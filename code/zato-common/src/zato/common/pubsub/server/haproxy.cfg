global
    maxconn 32000
    log stdout format raw local0

defaults
    mode http
    log global
    log-format '%ci - - [%t] "%r" %ST %B'
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

backend publish_backend
    balance roundrobin
    server publish1 localhost:40100 check

backend pull_backend
    balance roundrobin
    server pull1 localhost:40200 check

backend subscribe_backends
    balance roundrobin
    server publish1 localhost:40100 check
    server pull1 localhost:40200 check

frontend pubsub_frontend
    bind 0.0.0.0:44556

    option forwardfor
    option http-server-close

    # Route publish requests to publish backend
    acl is_publish path_beg /pubsub/topic/
    use_backend publish_backend if is_publish

    # Route message pull requests to pull backend
    acl is_pull path_beg /pubsub/messages/get
    use_backend pull_backend if is_pull

    # Route subscribe/unsubscribe to both backends (round robin)
    acl is_subscribe path_beg /pubsub/subscribe/
    acl is_unsubscribe path_beg /pubsub/unsubscribe/
    use_backend subscribe_backends if is_subscribe
    use_backend subscribe_backends if is_unsubscribe
