global
    maxconn 32000
    log stdout local0 debug

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option log-health-checks
    log global

backend publish_backend
    balance roundrobin
    server publish1 localhost:40100 check

backend pull_backend
    balance roundrobin
    server pull1 localhost:40200 check

backend subscribe_backends
    balance roundrobin
    server publish1 localhost:40100 check
    server pull1 localhost:40200 check

frontend pubsub_frontend
    bind 0.0.0.0:44556

    capture request header Host len 64
    capture request header User-Agent len 128
    capture request header Authorization len 128
    capture request header Content-Type len 64
    capture request header Content-Length len 16
    capture response header Content-Type len 64
    capture response header Content-Length len 16

    # Route publish requests to publish backend
    acl is_publish path_beg /pubsub/topic/
    use_backend publish_backend if is_publish

    # Route message pull requests to pull backend
    acl is_pull path_beg /pubsub/messages/get
    use_backend pull_backend if is_pull

    # Route subscribe/unsubscribe to both backends (round robin)
    acl is_subscribe path_beg /pubsub/subscribe/
    acl is_unsubscribe path_beg /pubsub/unsubscribe/
    use_backend subscribe_backends if is_subscribe
    use_backend subscribe_backends if is_unsubscribe
